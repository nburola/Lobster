---
title: "LETR Sites"
author: "Nathaniel Burola, Karan Shetty, Priscilla Hare"
date: "November 13, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#need to install lmtest package in order to install vcdExtra packages

library(tidyverse)
library(vcdExtra)
library(kableExtra)
library(gmodels)

```

```{r, include=FALSE}
lobster_size <- read_csv("lobster_size_abundance.csv")
lobster_trap <- read_csv("lobster_traps.csv")
lobster_size
lobster_trap
```


```{r}
#Make the counts in the lobster size table in tidy format

lobster_size_tidy <- as.data.frame(lobster_size) %>% 
  filter(size != "-99999") %>% 
  expand.dft(freq = "count")

```

```{r}

carp_traps <- lobster_trap %>% 
  filter(site == "CARP") %>% 
  select("year","site", "traps") %>% 
  group_by(year) %>% 
  summarize("CARP traps" = sum(traps)) 

aque_traps <- lobster_trap %>% 
  filter(site == "AQUE") %>% 
  select("year","site", "traps") %>% 
  group_by(year) %>% 
  summarize("AQUE traps" = sum(traps)) 
  
sizeCARP <- lobster_size_tidy %>% 
  filter(site == "CARP") %>% 
  select("year","site", "size") %>% 
  group_by(year) %>% 
  summarize(number = n()) 


CARPmerge <- merge(carp_traps, sizeCARP, by = "year")




```

```{r}
#Making graphs of counts at each site each year for lobsters 

lobster_count<-lobster_size_tidy %>% 
  select("year", "site", "size") %>% 
  group_by(year) %>% 
  count(site) 

 
abundance <- lobster_count %>% 
  ggplot(aes(x = year, y = n))+
  geom_col()+
  facet_wrap(~site)
abundance

```


```{r}

#graphs of avg counts for  traps


trap_count<-lobster_trap %>% 
  filter(site == "AQUE" | site == "CARP" | site == "IVEE" | site == "MOHK" |site == "NAPL") %>% 
  select("year", "site", "traps", "date") %>% 
  group_by(year, site, date) %>% 
  summarize("traps" = sum(traps)) 

#trap_graph <- trap_count %>% 
  #ggplot(aes(x = year, y = traps)) +
  #geom_col()+
  #facet_wrap(~site)
#trap_graph

#uses mean trap from surveys each year USE THIS INSTEAD OF TOTAL COUNTS ABOVE
trap_avg <- trap_count %>% 
  group_by(year, site) %>% 
  summarize(mean = mean(traps))

trap_graph_avg <- trap_avg %>% 
  ggplot(aes(x = year, y = mean)) +
  geom_col()+
  facet_wrap(~site)
trap_graph_avg




```

```{r}
#makes a graph comparing lobsters and traps

lobster_count2 <- as.data.frame(lobster_count) %>% 
  mutate(row = seq(1,30, by = 1))

trap_avg2 <- as.data.frame(trap_avg) %>% 
  mutate(row = seq(1,30, by =1))



lobster_trap_combine <- left_join(lobster_count2, trap_avg2, by = 'row')

comp_graph <- lobster_trap_combine %>% 
  ggplot(aes(x = year, y = n))
  geom_point() +
  facet_wrap(~site.x, scales = "free")

comp_graph
```



```{r}
# Part 3: Changes in lobster size between MPA and non-MPA sites

lobster_size_2012 = lobster_size_tidy %>%
  group_by(site, year) %>%
  select(year, site, size) %>% 
  filter(year == "2012")

lobster_size_2012

lobster_bar_2012 = ggplot(lobster_size_2012, aes(x = size))  +
  geom_bar(aes(color = site)) +
  facet_wrap(~ site) +
  xlab("Year") +
  ylab("Lobster size")

lobster_bar_2012

# same but for 2017
lobster_size_2017 = lobster_size_tidy %>% 
  group_by(site, year) %>% 
  select(year, site, size) %>% 
  filter(year == "2017")

lobster_bar_2017 = ggplot(lobster_size_2017, aes(x = size))  +
  geom_bar(aes(color = site)) +
  facet_wrap(~ site) +
  xlab("Year") +
  ylab("Lobster size")


lobster_bar_2017

# Created a bar graph displaying size counts across all five sites for 2012 and 2017. WIP



```

```{r}
# Comparison of individual sites (both MPAs and non-MPAs) for lobster counts and sizes from 2012 and from 2017.

# MPAs first: IVEE

IV_2012 = lobster_size_2012 %>% 
  filter(site == "IVEE") %>%
  ungroup(site, year) %>% 
  pull(size)

IV_2017 = lobster_size_2017 %>% 
  filter(site == "IVEE") %>%
  ungroup(site, year) %>% 
  pull(size)

IV_combined = lobster_size_tidy %>% 
  filter(site == "IVEE") %>% 
  group_by(year) %>% 
  filter(year == "2012" | year == "2017") %>% 
  select(year, size)

IV_hist = ggplot(IV_combined, aes(x = size)) +
  geom_histogram(aes(fill = year), show.legend = FALSE) +
  facet_wrap(~ year) +
  labs(y = "Frequency", x = "Size (mm)", title = "Lobster size frequency at Isla Vista MPA in 2012 and 2017")

IV_hist

IV_qq = ggplot(IV_combined, aes(sample = size)) +
  geom_qq(aes(color = year), show.legend = FALSE) +
  facet_wrap(~ year, scale = "free")

IV_qq

f_test_iv = var.test(IV_2012, IV_2017)


f_test_iv

t_test_iv = t.test(IV_2012, IV_2017, var.equal = TRUE)

t_test_iv # ignore this, this might be wrong. this is measuring true difference in mass when I think it should be difference in counts


# MPA 2: NAPL

npl_2012 = lobster_size_2012 %>% 
  filter(site == "NAPL")





```











```{r}
#Part 4: Proportions of legal (over 82.6mm) lobster sizes for each site

#create a table of counts for legal and illegal sizes
legal_lobster<-lobster_size_tidy %>% 
  filter(year == "2017") %>% 
  mutate(
    legal = case_when(
      size >= 82.6 ~ "legal",
      size < 82.6 ~ "illegal"
    )
  ) %>% 
  select("site", "size", "legal") %>% 
  group_by(site) %>% 
  count(legal) 
  

#spread the table to put in the format of a contingency table
legal_lobster2 <- as.data.frame(legal_lobster) %>% 
  spread(legal, n) 

legal_lobster3 <- legal_lobster2 %>% 
  select(-site)

rownames(legal_lobster3) <- c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

#create a table of proportions
legal_prop <- prop.table(as.matrix(legal_lobster3), 1)

legal_prop2 <- as.data.frame(legal_prop) %>% 
  mutate(site = c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")) %>% 
  select("site", "illegal", "legal")


#combines counts and proportions but not neat
#legal_matrix <- as.matrix(legal_lobster3)
#count_prop <- CrossTable(legal_matrix, digits = 3, prop.r = TRUE, prop.c = FALSE, prop.t = FALSE, prop.chisq = FALSE)
#count_prop

#making a joined table
legal_count_prop <- left_join(legal_lobster2, legal_prop2, by = 'site') %>% 
  select("site", "legal.x", "legal.y", "illegal.x", "illegal.y") %>% 
  mutate(legal.y = round(legal.y, 3),
         illegal.y = round(illegal.y, 3),
         site = c("Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk Reef", "Naples Reef" ))

#making the table pretty  
count_prop_table <- kable(
  legal_count_prop, 
  align = c('r', 'c', 'c', 'c', 'c', 'c'), #alligns the first column left, and all subsequent columns centered
  col.names = c(" ", "Count", "Proportion", "Count", "Proportion"), 
  caption = "Table x: insert description and chi-square test results here)." 
  )  %>%  
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE, font_size = 12) %>% 
  add_header_above(c(" ", "Legal" = 2, "Illegal" = 2)) %>%
  column_spec(1, bold = TRUE, color = "navy", width = "3cm")

count_prop_table

#run a chi square test on the table of counts
legal_x2 <- chisq.test(legal_lobster2)
legal_x2
legal_x2$stdres
```

